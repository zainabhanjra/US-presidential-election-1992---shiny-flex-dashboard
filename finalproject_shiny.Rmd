---
title: "1992 U.S. presidential election."
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: fill
    runtime: shiny
---


```{r setup, include=FALSE}
library(tinytex)
library(tidyverse)
library(plotly)
library(DT)
library(shiny)
library(tidyverse)
library(janitor)
library(readxl)
library(DataExplorer)
library(readxl)
library(dplyr)
library(readr)
library(ggplot2)
library(writexl)
library(corrplot)
library(purrr)
library(reshape2)

shinytest::installDependencies()
library(shinytest)

```

```{r}
dataset1 <- read_xlsx("D:/STAT 206/finalproject/finalproject submission files/Counties Data Set 1.xlsx")

dataset2 <- read_xlsx("D:/STAT 206/finalproject/finalproject submission files/Counties Data Set 2.xlsx")

dataset3 <- read_xlsx("D:/STAT 206/finalproject/finalproject submission files/Counties Data Set 3.xlsx")

missing_per1<- colMeans(is.na(dataset1)) * 100

missing_per2<- colMeans(is.na(dataset2)) * 100

missing_per3<- colMeans(is.na(dataset3)) * 100


dataset1[is.na(dataset1)]<-0

dataset2[is.na(dataset2)]<-0

dataset3[is.na(dataset3)]<-0



dataset1<-clean_names(dataset1)

dataset2<-clean_names(dataset2)

dataset3<-clean_names(dataset3)



dataset1 <- dataset1 %>% 
  rename_with(~ janitor::make_clean_names(.))


dataset2 <- dataset2 %>% 
  rename_with(~ janitor::make_clean_names(.))

dataset3 <- dataset3 %>% 
  rename_with(~ janitor::make_clean_names(.))




dataset3 <- dataset3 %>%
  rename(pop_density = population_density)
  
dataset2 <- dataset2 %>%
  rename(democrat = democrate)

combined_data<-rbind(dataset1,dataset2,dataset3)

write_xlsx(combined_data,"combined_data.xlsx")

summary_shiny <- combined_data %>%
  group_by(state) %>%
  summarize(
    avg_population = mean(pop),
    SD_pop = sd(pop),
    avg_pop_density = mean(pop_density),
    SD_pop_density = sd(pop_density),
    avg_democrat = mean(democrat),
    SD_democrat = sd(democrat),
    avg_republican = mean(republican),
    SD_republican = sd(republican),
    avg_white = mean(white),
    SD_white = sd(white),
    avg_black = mean(black),
    SD_black = sd(black),
    avg_turnout = mean(turnout),
    SD_turnout = sd(turnout),
    by = NULL
    )


numeric_columns <- sapply(combined_data, is.numeric)
continuous_variables <- names(combined_data)[numeric_columns]
#print(continuous_variables)

```


Table
========================================


```{r}

h4(em(strong("This table shows the averages and standard deviations of population size, population density, number of democrats and number of republicans, number white and black population and turnout with respect to state.")))


output$mytable <- DT::renderDT({
summary_shiny <- combined_data %>%
  group_by(state) %>%
  summarize(
    avg_population = mean(pop),
    SD_pop = sd(pop),
    avg_pop_density = mean(pop_density),
    SD_pop_density = sd(pop_density),
    avg_democrat = mean(democrat),
    SD_democrat = sd(democrat),
    avg_republican = mean(republican),
    SD_republican = sd(republican),
    avg_white = mean(white),
    SD_white = sd(white),
    avg_black = mean(black),
    SD_black = sd(black),
    avg_turnout = mean(turnout),
    SD_turnout = sd(turnout)
  )
print(summary_shiny)
    datatable(
      summary_shiny,
      extensions = "Buttons",
      options = list(
        dom = "Bfrtip",
        buttons = list("csv", "excel", "print", "pdf")
      )
    )
})
dataTableOutput("mytable")

h4(em(strong("This table shows the averages and standard deviations of population size, population density, number of democrats and number of republicans, number white and black population and turnout with respect to state.")))
```




Box and Whisker Plots
========================================
Column {.sidebar data-width=200}
-----------------------------------------------------------------------
It is better to display each variable separately to attain a clear representation for meaningful interpretations and avoid a messy graph.


Column {.tabset data-width=600}
-----------------------------------------------------------------------

### Population size average

```{r}
h4(em(strong("This plot shows the average of population size with respect to state.")))


output$boxPlot1 <- renderPlot({
  summary_shiny <- combined_data %>%
  group_by(state) %>%
  summarize(
    avg_pop = mean(pop)
  )
  pop_boxplot1 <- ggplot(summary_shiny, aes(x = state,y=avg_pop)) +
  geom_boxplot() +
  labs(title = "Boxplot of average population size by State")+
      theme_minimal()
  print(pop_boxplot1)
})

plotOutput("boxPlot1")
  

```

### Population size SD

```{r}

h4(em(strong("This plot shows the standard deviation of population with respect to state.")))

output$boxPlot2 <- renderPlot({
  summary_shiny <- combined_data %>%
  group_by(state) %>%
  summarize(
    SD_pop = sd(pop)
  )
  pop_boxplot2 <- ggplot(summary_shiny, aes(x = state,y=SD_pop)) +
  geom_boxplot() +
  labs(title = "Boxplot of Population Density sd by State")+
      theme_minimal()
  print(pop_boxplot2)
})

plotOutput("boxPlot2")

```

### Democrats average

```{r}
h4(em(strong("This plot shows the average of number of democrats with respect to state.")))

output$boxPlot3 <- renderPlot({
  summary_shiny <- combined_data %>%
  group_by(state) %>%
  summarize(
    avg_democrat = mean(democrat)
  )
  pop_boxplot3<- ggplot(summary_shiny, aes(x = state,y=avg_democrat)) +
  geom_boxplot() +
  labs(title = "Boxplot of average democrats by State")+
      theme_minimal()
  print(pop_boxplot3)
})

plotOutput("boxPlot3")

```

### Democrats sd

```{r}

h4(em(strong("This plot shows the standard deviation of democrats with respect to state.")))

output$boxPlot4 <- renderPlot({
  summary_shiny <- combined_data %>%
  group_by(state) %>%
  summarize(
   SD_democrat = sd(democrat)
  )
  pop_boxplot4<- ggplot(summary_shiny, aes(x = state,y=SD_democrat)) +
  geom_boxplot() +
  labs(title = "Boxplot of democrats sd by State")+
      theme_minimal()
  print(pop_boxplot4)
})

plotOutput("boxPlot4")

```


### Republicans average

```{r}
h4(em(strong("This plot shows the average of number of republicans with respect to state.")))

output$boxPlot5 <- renderPlot({
  summary_shiny <- combined_data %>%
  group_by(state) %>%
  summarize(
    avg_republican = mean(republican)
  )
  pop_boxplot5<- ggplot(summary_shiny, aes(x = state,y=avg_republican)) +
  geom_boxplot() +
  labs(title = "Boxplot of average republicans by State")+
      theme_minimal()
  print(pop_boxplot5)
})

plotOutput("boxPlot5")

```

### Republicans sd

```{r}
h4(em(strong("This plot shows the standard deviation of number of republicans with respect to state.")))

output$boxPlot6 <- renderPlot({
  summary_shiny <- combined_data %>%
  group_by(state) %>%
  summarize(
   SD_republican = sd(republican)
  )
  pop_boxplot6<- ggplot(summary_shiny, aes(x = state,y=SD_republican)) +
  geom_boxplot() +
  labs(title = "Boxplot of average republicans by State")+
      theme_minimal()
  print(pop_boxplot6)
})

plotOutput("boxPlot6")

```

### White Population average

```{r}
h4(em(strong("This plot shows the average of white population with respect to state.")))

output$boxPlot7 <- renderPlot({
  summary_shiny <- combined_data %>%
  group_by(state) %>%
  summarize(
    avg_white = mean(white)
  )
  pop_boxplot7<- ggplot(summary_shiny, aes(x = state,y=avg_white)) +
  geom_boxplot() +
  labs(title = "Boxplot of white population average by State")+
      theme_minimal()
  print(pop_boxplot7)
})

plotOutput("boxPlot7")

```

### White Population sd

```{r}
h4(em(strong("This plot shows the standard deviation of white population with respect to state.")))

output$boxPlot8 <- renderPlot({
  summary_shiny <- combined_data %>%
  group_by(state) %>%
  summarize(
   SD_white = sd(white)
  )
  pop_boxplot8<- ggplot(summary_shiny, aes(x = state,y=SD_white)) +
  geom_boxplot() +
  labs(title = "Boxplot of white sd by State")+
      theme_minimal()
  print(pop_boxplot8)
})

plotOutput("boxPlot8")

```

### Black Population average

```{r}
h4(em(strong("This plot shows the average of black population with respect to state.")))

output$boxPlot9 <- renderPlot({
  summary_shiny <- combined_data %>%
  group_by(state) %>%
  summarize(
    avg_black = mean(black)
  )
  pop_boxplot9<- ggplot(summary_shiny, aes(x = state,y=avg_black)) +
  geom_boxplot() +
  labs(title = "Boxplot of average black population by State")+
      theme_minimal()
  print(pop_boxplot9)
})

plotOutput("boxPlot9")

```

### Black Population sd

```{r}
h4(em(strong("This plot shows the standard deviation of black population with respect to state.")))

output$boxPlot10 <- renderPlot({
  summary_shiny <- combined_data %>%
  group_by(state) %>%
  summarize(
   SD_black = sd(black)
  )
  pop_boxplot10<- ggplot(summary_shiny, aes(x = state,y=SD_black)) +
  geom_boxplot() +
  labs(title = "Boxplot of black sd by State")+
      theme_minimal()
  print(pop_boxplot10)
})

plotOutput("boxPlot4")

```


### Turnout average


```{r}
h4(em(strong("This plot shows the average of turnout with respect to state.")))

output$boxPlot11 <- renderPlot({
  summary_shiny <- combined_data %>%
  group_by(state) %>%
  summarize(
    avg_turnout = mean(turnout)
  )
  pop_boxplot11<- ggplot(summary_shiny, aes(x = state,y=avg_turnout)) +
  geom_boxplot() +
  labs(title = "Boxplot of turnout average by State")+
      theme_minimal()
  print(pop_boxplot11)
})

plotOutput("boxPlot11")

```

### Turnout sd


```{r}
h4(em(strong("This plot shows the standard deviation of turnout with respect to state.")))

output$boxPlot12 <- renderPlot({
  summary_shiny <- combined_data %>%
  group_by(state) %>%
  summarize(
   SD_turnout = sd(turnout)
  )
  pop_boxplot12<- ggplot(summary_shiny, aes(x = state,y=SD_turnout)) +
  geom_boxplot() +
  labs(title = "Boxplot of turnout sd by State")+
      theme_minimal()
  print(pop_boxplot12)
})

plotOutput("boxPlot12")

```



Density Plot 1
========================================

Column {.sidebar data-width=200}
-----------------------------------------------------------------------
age75, age6574, income, democrats, republicans and turnout show a normal distribution implying that these variables are majorly present at the average number rather than the extremes. white, farm and black density plots show log-normal distribution with most of the white population density lying in the positive end of the spectrum and the other two i.e., number of farms and black population showing most of the shift towards the lower end. pop_change, college and crime data are mostly displaying skewed distributions towards the left end. pop_density and pop show little to no distribution and that too moslty being concentrated at the left end.

Column {.tabset data-width=350}
-----------------------------------------------------------------------


```{r}

h4(em(strong("The plots show the density distribution of the continuous variables of combined_data")))


  output$densityPlot1 <- renderPlot({
    
    continuous_vars <- c("pop_density", "pop", "pop_change", "age6574", "age75",
                         "crime", "college")
   
     plots <- list()
     
    for (var in continuous_vars) {
      plots[[var]] <- ggplot(combined_data, aes_string(x = var)) +
        geom_density(fill = "green", alpha = 0.5) +
        labs(title = paste("Density Plot of", var)) +
        theme_minimal()
    }
     
    library(gridExtra)
    grid.arrange(grobs = plots, ncol = 2)
    
  })


    
plotOutput("densityPlot1")
    



```

Density Plot 2
========================================
Column {.sidebar data-width=200}
-----------------------------------------------------------------------
age75, age6574, income, democrats, republicans and turnout show a normal distribution implying that these variables are majorly present at the average number rather than the extremes. white, farm and black density plots show log-normal distribution with most of the white population density lying in the positive end of the spectrum and the other two i.e., number of farms and black population showing most of the shift towards the lower end. pop_change, college and crime data are mostly displaying skewed distributions towards the left end. pop_density and pop show little to no distribution and that too moslty being concentrated at the left end.

Column {.tabset data-width=350}
-----------------------------------------------------------------------


```{r}

h4(em(strong("The plots show the density distribution of the continuous variables of combined_data")))

  output$densityPlot2 <- renderPlot({
    
    continuous_vars <- c("income", "farm", "democrat",
                         "republican", "white", "black", "turnout")
   
     plots <- list()
     
    for (var in continuous_vars) {
      plots[[var]] <- ggplot(combined_data, aes_string(x = var)) +
        geom_density(fill = "red", alpha = 0.5) +
        labs(title = paste("Density Plot of", var)) +
        theme_minimal()
    }
     
    library(gridExtra)
    grid.arrange(grobs = plots, ncol = 2)
    
  })


    
plotOutput("densityPlot2")
    



```




Correlation Plot
========================================
Column {.sidebar data-width=200}
-----------------------------------------------------------------------
Black and white populations (dark red) show the strongest negative correlation(dark red) while all variables show a very strong correlation with the same variables indicating the relationship of these variables across different states and counties. White regions on the graph indicate that variables like age and political affiliations (i.e., democrats and republicans) have zero correlation. Other variables and the ranges of correlation are indicated by the colour scale.

Column { data-width=350}
-----------------------------------------------------------------------



```{r}

h4(em(strong("This plot displays the correlation between continuous variables of combined_data")))


all_continuous_vars <- c("pop_density", "pop", "pop_change", "age6574", "age75", 
               "crime", "college", "income", "farm", "democrat", 
               "republican", "white", "black", "turnout")


matrix_correlation <- cor(combined_data[all_continuous_vars], use = "pairwise.complete.obs")

corrplot(matrix_correlation, method = "color", type = "upper", order = "hclust", tl.col = "red")


```

Bar Plot
========================================
Column { data-width=350}
-----------------------------------------------------------------------


```{r}
h4(em(strong("This plot displays the comparison of average black and white population in each state.")))


 output$barplot <- renderPlotly({
   barplot_data <- combined_data %>%
     group_by(state) %>%
     summarise(avg_white= mean(white),avg_black= mean(black))
   
   plot <- ggplot(barplot_data, aes(x = state, y = avg_white,fill = "White Population")) +
     geom_bar(stat = "identity", position = "dodge") +
     geom_bar(aes(y = avg_black, fill = "Black Population"), stat = "identity", position = "dodge") +
     labs(x = "State", y = "Average Population", fill = "Race") +
     scale_fill_manual(values = c("purple", "turquoise")) +
     theme_minimal()
   
   ggplotly(plot)
   
   })

plotlyOutput("barplot")



```
